<div class="qd-page">
  <div class="qd-container">
    <div class="qd-card">
      {{#if this.currentUser.admin}}
        <div class="qd-admin-debug">
          <button class="debug-btn" {{on "click" this.openAdminDebug}}>
            ğŸ› ï¸ ç®¡ç†å‘˜è°ƒè¯•
          </button>
        </div>
      {{/if}}
      
      <div class="qd-header">
        <h1 class="qd-title">ğŸ¯ æ¯æ—¥ç­¾åˆ°</h1>
        <p class="qd-subtitle">åšæŒç­¾åˆ°ï¼Œç§¯ç´¯ç§¯åˆ†</p>
      </div>
      
      {{#if this.model.user_logged_in}}
        <div class="qd-stats-grid">
          <div class="qd-stat-item">
            <div class="qd-stat-value">{{this.model.today_score}}</div>
            <div class="qd-stat-label">ä»Šæ—¥ç§¯åˆ†</div>
          </div>
          <div class="qd-stat-item">
            <div class="qd-stat-value">{{this.model.total_score}}</div>
            <div class="qd-stat-label">å¯ç”¨ç§¯åˆ†</div>
          </div>
          <div class="qd-stat-item">
            <div class="qd-stat-value">{{this.model.consecutive_days}}</div>
            <div class="qd-stat-label">è¿ç»­ç­¾åˆ°å¤©æ•°</div>
          </div>
          <div class="qd-stat-item">
            <div class="qd-stat-value">{{this.model.points}}</div>
            <div class="qd-stat-label">åŸºç¡€å¥–åŠ±</div>
          </div>
        </div>

        {{#if this.model.consecutive_days}}
          <div class="qd-consecutive-info">
            <h4>ğŸ”¥ è¿ç»­ç­¾åˆ°å¥–åŠ±</h4>
            <p>å·²è¿ç»­ç­¾åˆ° <strong>{{this.model.consecutive_days}}</strong> å¤©ï¼</p>
            <div class="qd-reward-tips">
              <small>{{this.rewardText}}</small>
            </div>
          </div>
        {{/if}}
        
        <div class="qd-sign-section">
          <button 
            class="btn btn-large qd-sign-btn {{if this.model.signed 'btn-default' 'btn-primary'}}" 
            {{on "click" this.signIn}}
            disabled={{or this.model.signed this.isLoading}}
          >
            {{#if this.isLoading}}
              â³ å¤„ç†ä¸­...
            {{else if this.model.signed}}
              âœ… ä»Šæ—¥å·²ç­¾åˆ°
            {{else}}
              ğŸ¯ ç«‹å³ç­¾åˆ°
            {{/if}}
          </button>
          
          <div class="qd-status-message {{if this.model.signed 'success' 'info'}}">
            {{#if this.model.signed}}
              ä»Šæ—¥ç­¾åˆ°å®Œæˆï¼Œæ˜å¤©å†æ¥å§ï¼è¿ç»­ç­¾åˆ° {{this.model.consecutive_days}} å¤©
            {{else}}
              ç‚¹å‡»æŒ‰é’®å®Œæˆä»Šæ—¥ç­¾åˆ°ï¼Œè·å¾— {{this.model.points}} ç§¯åˆ†
            {{/if}}
          </div>
        </div>

        <div class="qd-makeup-section">
          <div class="qd-makeup-header">
            <h4>ğŸ“ è¡¥ç­¾åŠŸèƒ½</h4>
            <div class="qd-makeup-cards">
              è¡¥ç­¾å¡ï¼š{{this.model.makeup_cards}} å¼ 
            </div>
          </div>
          
          {{#if this.missingDays}}
            <div class="qd-missed-days">
              {{#each this.missingDays as |day|}}
                <div class="qd-missed-day">
                  <div class="qd-day-date">{{day.formatted_date}}</div>
                  <button class="qd-makeup-btn" 
                          {{on "click" (fn this.makeupSign day.date)}}
                          disabled={{this.noMakeupCards}}>
                    {{#if this.noMakeupCards}}
                      æ— å¡
                    {{else}}
                      è¡¥ç­¾
                    {{/if}}
                  </button>
                </div>
              {{/each}}
            </div>
          {{else}}
            <div class="qd-no-missed">
              ğŸ‰ æ²¡æœ‰ç¼ºå‹¤è®°å½•
            </div>
          {{/if}}
        </div>

        {{#if this.makeupMessage}}
          <div class="qd-buy-message success">
            <span class="qd-buy-icon">âœ…</span>
            <span class="qd-buy-text">{{this.makeupMessage}}</span>
          </div>
        {{/if}}

        {{#if this.makeupError}}
          <div class="qd-buy-message error">
            <span class="qd-buy-icon">âŒ</span>
            <span class="qd-buy-text">{{this.makeupError}}</span>
          </div>
        {{/if}}

        <div class="qd-shop-section">
          <div class="qd-shop-header">
            <h4>ğŸ’° è¡¥ç­¾å¡å•†åº—</h4>
            <p>ç”¨ç§¯åˆ†è´­ä¹°è¡¥ç­¾å¡ï¼Œè¡¥ç­¾è¿‡å»çš„ç¼ºå‹¤æ—¥æœŸ</p>
          </div>
          <div class="qd-shop-item">
            <div class="qd-item-info">
              <div class="qd-item-name">è¡¥ç­¾å¡ x1</div>
              <div class="qd-item-price">{{this.model.makeup_card_price}} ç§¯åˆ†</div>
            </div>
            <button class="qd-buy-btn" {{on "click" this.buyMakeupCard}}
                    disabled={{this.insufficientPoints}}>
              {{#if this.insufficientPoints}}
                ç§¯åˆ†ä¸è¶³
              {{else}}
                è´­ä¹°
              {{/if}}
            </button>
          </div>
          
          {{#if this.buyMessage}}
            <div class="qd-buy-message success">
              <span class="qd-buy-icon">âœ…</span>
              <span class="qd-buy-text">{{this.buyMessage}}</span>
            </div>
          {{/if}}
          
          {{#if this.buyError}}
            <div class="qd-buy-message error">
              <span class="qd-buy-icon">âŒ</span>
              <span class="qd-buy-text">{{this.buyError}}</span>
            </div>
          {{/if}}
        </div>
      {{else}}
        <div class="qd-sign-section">
          <LinkTo @route="login" class="btn btn-large btn-primary qd-login-btn">
            ğŸ” ç™»å½•åç­¾åˆ°
          </LinkTo>
          <div class="qd-status-message info">
            ç™»å½•åå³å¯å¼€å§‹æ¯æ—¥ç­¾åˆ°è·å–ç§¯åˆ†
          </div>
        </div>
      {{/if}}
    </div>

    <!-- ç­¾åˆ°è®°å½•åˆ—è¡¨ï¼ˆæœ€è¿‘ 7 å¤©ï¼ŒæŒ‰æ—¶é—´å€’åºï¼‰ -->
    {{#if this.model.user_logged_in}}
      <div class="qd-records-section">
        <h4>ğŸ—“ï¸ ç­¾åˆ°è®°å½•ï¼ˆæœ€è¿‘ 7 å¤©ï¼‰</h4>
        {{#if this.records.length}}
          <ul class="qd-records-list">
            {{#each this.records as |r|}}
              <li class="qd-record-item">
                <span class="qd-record-date">{{r.date}}</span>
                <span class="qd-record-points">+{{r.points}} åˆ†</span>
                <span class="qd-record-makeup">{{if r.makeup "è¡¥ç­¾" "æ­£å¸¸"}}</span>
                <span class="qd-record-streak">è¿ç»­ï¼š{{r.streak_count}} å¤©</span>
              </li>
            {{/each}}
          </ul>
        {{else}}
          <div class="qd-no-records">æš‚æ— ç­¾åˆ°è®°å½•</div>
        {{/if}}
      </div>
    {{/if}}
    
    <div class="qd-install-info">
      ğŸ“… ç­¾åˆ°ç³»ç»Ÿäº {{this.model.install_date}} æ­£å¼å¯ç”¨<br>
      ğŸ’¡ æ¯æ—¥ç­¾åˆ°å¯è·å¾— {{this.model.points}} ç§¯åˆ†ï¼Œè¿ç»­ç­¾åˆ°è·å¾—æ›´å¤šæˆå°±æ„Ÿ
    </div>
  </div>
</div>

{{!-- è¡¥ç­¾ç¡®è®¤å¼¹çª— --}}
{{#if this.showMakeupConfirm}}
  <div class="qd-confirm-modal">
    <div class="qd-confirm-content">
      <h3>ç¡®è®¤è¡¥ç­¾</h3>
      <p>ç¡®å®šè¡¥ç­¾ <strong>{{this.selectedMakeupDate}}</strong> å—ï¼Ÿå°†æ¶ˆè€— <strong>1 å¼ è¡¥ç­¾å¡</strong>ã€‚</p>
      <p class="qd-confirm-note">è¡¥ç­¾ä»…åœ¨ç³»ç»Ÿå¯ç”¨æ—¥ä¹‹åæœ‰æ•ˆï¼Œå¾—åˆ†æŒ‰è®¾ç½®æ¯”ä¾‹è®¡ç®—</p>

      <div class="qd-confirm-buttons">
        <button class="qd-confirm-cancel" {{on "click" this.cancelMakeupConfirm}} disabled={{this.isLoading}}>
          å–æ¶ˆ
        </button>
        <button class="qd-confirm-ok" {{on "click" this.confirmMakeupSign}} disabled={{this.isLoading}}>
          {{#if this.isLoading}}å¤„ç†ä¸­...{{else}}ç¡®è®¤è¡¥ç­¾{{/if}}
        </button>
      </div>
    </div>
  </div>
{{/if}}

{{!-- è´­ä¹°è¡¥ç­¾å¡ç¡®è®¤å¼¹çª— --}}
{{#if this.showBuyConfirm}}
  <div class="qd-confirm-modal">
    <div class="qd-confirm-content">
      <h3>ç¡®è®¤è´­ä¹°</h3>
      <p>æ‚¨ç¡®å®šè¦ä½¿ç”¨ <strong>{{this.model.makeup_card_price}} ç§¯åˆ†</strong> è´­ä¹° <strong>1 å¼ è¡¥ç­¾å¡</strong> å—ï¼Ÿ</p>
      <p class="qd-confirm-note">è´­ä¹°åå¯ç”¨äºè¡¥ç­¾ç¼ºå‹¤æ—¥æœŸï¼Œæ¯æ¬¡è¡¥ç­¾æ¶ˆè€— 1 å¼ è¡¥ç­¾å¡</p>
      
      <div class="qd-confirm-buttons">
        <button class="qd-confirm-cancel" {{on "click" this.cancelBuyConfirm}} disabled={{this.isLoading}}>
          å–æ¶ˆ
        </button>
        <button class="qd-confirm-ok" {{on "click" this.confirmBuyMakeupCard}} disabled={{this.isLoading}}>
          {{#if this.isLoading}}
            å¤„ç†ä¸­...
          {{else}}
            ç¡®è®¤è´­ä¹°
          {{/if}}
        </button>
      </div>
    </div>
  </div>
{{/if}}

{{!-- ç®¡ç†å‘˜è°ƒè¯•å¼¹çª— --}}
{{#if this.showDebugModal}}
  <div class="debug-modal">
    <div class="debug-content">
      <h3>ğŸ› ï¸ ç®¡ç†å‘˜è°ƒè¯•ï¼ˆä»…ç®¡ç†å‘˜ï¼‰</h3>

      <div class="debug-section">
        <h4>æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†</h4>
        <div class="debug-form">
          <Input @value={{this.adminUsernameAdjust}} placeholder="ç”¨æˆ·åï¼Œä¾‹å¦‚: alice" />
          <Input @value={{this.adminDelta}} @type="number" placeholder="è°ƒæ•´å€¼ï¼ˆå¯æ­£å¯è´Ÿï¼‰ï¼Œä¾‹å¦‚ï¼š+10 æˆ– -5" />
          <button class="btn-warning" {{on "click" this.adjustPoints}} disabled={{this.isLoading}}>
            {{if this.isLoading "å¤„ç†ä¸­..." "ä¿å­˜å¹¶åº”ç”¨"}}
          </button>
        </div>
      </div>

      <div class="debug-section">
        <h4>é‡ç½®ä»Šæ—¥ç­¾åˆ°</h4>
        <div class="debug-form">
          <Input @value={{this.adminUsernameReset}} placeholder="ç”¨æˆ·åï¼Œä¾‹å¦‚: alice" />
          <button class="btn-danger" {{on "click" this.resetToday}} disabled={{this.isLoading}}>
            {{if this.isLoading "å¤„ç†ä¸­..." "é‡ç½®ä»Šæ—¥ç­¾åˆ°"}}
          </button>
        </div>
      </div>


      {{#if this.adminMessage}}
        <div class="debug-section">
          <h4>ç»“æœ</h4>
          <div>{{this.adminMessage}}</div>
        </div>
      {{/if}}

      {{#if this.adminError}}
        <div class="debug-section">
          <h4>é”™è¯¯</h4>
          <div>{{this.adminError}}</div>
        </div>
      {{/if}}

      <div class="debug-close">
        <button {{on "click" this.closeAdminDebug}}>å…³é—­</button>
      </div>
    </div>
  </div>
{{/if}}